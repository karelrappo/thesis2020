---
title: "Appendices"
date: "12.11-2020"
output: 
  bookdown::pdf_document2:
    toc: no
csl: apa.csl
bibliography: library.bib
indent: yes
fontsize: 12pt
geometry: margin = 1in
link-citations: yes
linkcolor: blue
urlcolor: blue
header-includes:
- \usepackage{placeins}
- \usepackage{setspace}
- \usepackage{chngcntr}
- \usepackage{microtype}
- \counterwithin{figure}{section}
- \counterwithin{table}{section}
- \usepackage{float}
- \usepackage{amsmath}
- \DeclareMathOperator{\logit}{logit}

---

# Appendices
```{r run libraries, include=F}
library(stringr)
library(tidyverse)
library(summarytools)
library(kableExtra)
library(dynlm)
library(stats)
library(readr)
library(dplyr)
library(ggplot2)
library(MacroRF)
require(data.table)
library(zoo)
library(sandwich)
library(randomForest)
library(caret)
library(fbi)
library(lmtest)
library(purrr)
library(broom)
library(rollRegres)
library(modelr)
library(Metrics)
library(mltools)
library(forcats)
library(tibble)
library(reshape2)
library(lmtest)
```


```{r child = 'Dataclean.rmd'}

```

```{r model, include=FALSE}

regrs <- function(mudelid)
  {
  df_total <- df %>%
  select(H4, H6, H8, H10, H12, mudelid) %>%
  gather(Var,Value,  -mudelid) %>%
  nest(data=c(Value,  mudelid)) %>%
  mutate(model = map(data, ~lm(Value ~ ., data = .)),
         tidied = map(model, tidy),
         glanced = map(model, glance),
         augmented = map(model, augment),
         neweywest = map(model, ~tidy(coeftest(., vcov.=NeweyWest(., prewhite=FALSE))))) %>%
  select(-model, -data)
return(df_total)
}

# siit kaotasin Ã¤ra intercept selle filteriga
regr_results <- function(a){
  results1 <- a %>%
    select(-augmented,-tidied, -glanced) %>%
    unnest(cols = c(neweywest)) %>%
    select(-statistic) %>%
    pivot_longer(cols=-c(1:2), names_to = "mdeea", values_to = "Delay") %>%
    mutate(x = paste(term,mdeea,sep = "_"))%>%
    filter(!grepl('Intercept', term)) %>%
    select(-c(2:3)) %>%
    pivot_wider(names_from = Var, values_from = Delay) %>%
    column_to_rownames(var = "x")
    

  results2 <- a %>%
    select(-augmented,-neweywest, -tidied) %>%
    unnest(cols = c(glanced)) %>%
    select(-df, -AIC, -BIC, -deviance, -nobs, -df.residual, -logLik, -statistic, -p.value) %>%
    column_to_rownames(var = "Var")
  results2 <- as.data.frame(t(results2))

  results <- rbind(results1, results2)
  remove(results1, results2)
  rownames(results)[rownames(results) == "sigma"] <- "RMSE"
  
return(results)
}

```


```{r child = 'roll_regress.rmd', include=FALSE}

```


```{r, include=F}
order <- c("GDP", "YIV", "EMP", "CON")
statistics <- df_summary %>%
  descr(
    transpose = TRUE,
    stats = c("mean","sd","min","q1","med","q3","max","n.valid"))

statistics <- statistics %>%
  mutate(Variable=rownames(statistics)) %>%
  relocate(Variable)

```

## Appendix A

```{r reg_graphs, message = F, warnings = F, echo = F, fig.height=3, fig.width=6}
regr1 <- regrs(mudelid=c("YIV"))
results1 <- regr_results(a=regr1)
results1 <- as.data.frame(t(results1))


regression.coefficients <- ggplot(results1, aes(x=row.names(results1), y=YIV_estimate))+ geom_bar(stat="identity", fill="steelblue")+theme_minimal()+ xlab("Quarters") + ylab("Coefficients") + labs(title = "GDP coefficients") + theme(plot.title = element_text(hjust = 0.5)) + scale_x_discrete(limits=c("H4", "H6", "H8", "H10", "H12"))

regression.fit <- ggplot(results1, aes(x=row.names(results1),y=r.squared)) + geom_bar(stat="identity", fill="steelblue")+ theme_minimal() + xlab("Quarters") + ylab("R-squared") + labs(title = "GDP R-squared") +  theme(plot.title = element_text(hjust = 0.5)) + scale_x_discrete(limits=c("H4", "H6", "H8", "H10", "H12"))

regression.fit
regression.coefficients
```

\newpage
## Appendix B

```{r GDPvsYIV, message=F, warnings=F, echo = F, fig.cap="GDP Growth(%) vs 5-year Treasury Implied Volatility"}
par(mar = c(5, 5, 3, 5))
plot(df$Date, df$YIV, type = "l", xlab = "Date", ylab = "YIV (%)", col = "blue", main = "GDP growth vs YIV")
par(new=TRUE)
plot(df$Date, df$GDP, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", col = "red", lty = 2)
axis(side = 4)
mtext("GDP growth(%)", side = 4, line = 3)
legend("topleft", c("YIV", "GDP"),
       col = c("blue", "red"), lty = c(1, 2))
```

\newpage
## Appendix C

Notes: This table includes summary statistics for main variables used in our research. Statistics include mean, standard deviation,, min, 1st quartile, median, 3rd quartile, max & number of valid data points. 
In Panel A, different YIV data is summarized. 
In Panel B, we have listed the main dependent variables which are used for predictions. GDP denotes the year-on-year growth rate(quarterly data), CON denotes YOY consumption growth(monthly data), EMP describes YOY growth rate for non-farm payroll and lastly IND stands for Industrial production YOY growth (monthly data).
In Panel C, different control variables are listed: SVEN1F01 - 1 year treasury bond par yield.


```{r summarystat, message = F, warnings = F, echo = F}

statistics %>%
  select(-N.Valid) %>%
  arrange(match(Variable, c("YIV", "GDP", "CON", "EMP", "IND")), desc(Mean)) %>%
  kbl(booktabs = T,  longtable=T, align="c", digits=2, caption="Summary Statistics") %>%
  kable_styling(latex_options = c("striped","repeat_header")) %>%
  group_rows("Panel A: YIV",1,1, latex_align="c") %>%
  group_rows("Panel B: Dependent Variables",2,5, latex_align="c") %>%
  group_rows("Panel C: Control Variables",6,18, latex_align="c") %>%
  footnote(general = "The variables are shown prior to the standardization process.", threeparttable=T)
```
\newpage


## Appendix D. 

Notes: This table depicts the output of regression with YIV as independent variable. The equation for the regression is following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} +\varepsilon_{t+H}
\end{equation}

```{r OLS1, message = F, warnings = F,echo = F}
regr1 <- regrs(mudelid=c("YIV"))
results1 <- regr_results(a=regr1)

results1 %>%
  kbl(booktabs = T, longtable=T, align="c", digits=2, caption="Regression output") %>%
  kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
  footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

#grangertest(log_gdp ~ YIV, order=1, df)
```
\newpage
## Appendix E. 

Notes: YIV and dummy as independent variables. The equation for the regression is following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} + Dummy +\varepsilon_{t+H}
\end{equation}

```{r OLS2, message = F, warnings = F,echo = F}
regr2 <- regrs(mudelid=c("YIV", "dum"))
results2 <- regr_results(a=regr2)

results2  %>%
  kbl(booktabs = T,longtable=T, align="c", digits=2, caption="Regression with state-dependency") %>%
   kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
       footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

```

\newpage
## Appendix F. 

Notes: This table includes regression using YIV and GDP lags. The equation for the regression is following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} + lag[log(1+GDP_{i,t+j})] +\varepsilon_{t+H}
\end{equation}

```{r OLS3, message = F, warnings = F,echo = F}
lag_selection1 <- lm(log_gdp ~ lag1, df)
lag_selection2 <- lm(log_gdp ~ lag1+lag2, df)
lag_selection3 <- lm(log_gdp ~ lag1+lag2+lag3, df)
lag_selection4 <- lm(log_gdp ~ lag1+lag2+lag3+lag4, df)

extractAIC(lag_selection1)
extractAIC(lag_selection2)
extractAIC(lag_selection3)
extractAIC(lag_selection4)

BIC(lag_selection1)
BIC(lag_selection2)
BIC(lag_selection3)
BIC(lag_selection4)


regr3 <- regrs(mudelid=c("YIV", "lag1", "lag2"))
results3 <- regr_results(a=regr3)

results3  %>%
  kbl(booktabs = T,longtable=T, align="c", digits=2, caption="Regression with state-dependency") %>%
   kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
       footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

```
\newpage
## Appendix G. 

Notes: This table includes regression using GDP lags and controls. The equation for the regression is following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} + lag[log(1+GDP_{i,t+j})] +\varepsilon_{t+H}
\end{equation}

```{r OLS4, message = F, warnings = F,echo = F}
regr4 <- regrs(mudelid=c("lag1", "lag2", "DGS1", "DGS10", "DGS5", "DGS3MO", "TRM0503","TRM0506","TRM1003","TRM1006","TRM1012", "SRT03M", "AAA", "DBAA", "VIX", "housng"))
results4 <- regr_results(a=regr4)

results4  %>%
  kbl(booktabs = T,longtable=T, align="c", digits=2, caption="Regression with state-dependency") %>%
   kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
       footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

```

\newpage
## Appendix H. 

Notes: YIV, dummy, GDP lags and controls as independent variables. The equation for the regression is following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} + lag[log(1+GDP_{i,t+j})] +\varepsilon_{t+H}
\end{equation}

```{r OLS5, message = F, warnings = F,echo = F}
regr5 <- regrs(mudelid=c("YIV", "dum", "lag1", "lag2", "DGS1", "DGS10", "DGS5", "DGS3MO", "TRM0503","TRM0506","TRM1003","TRM1006","TRM1012", "SRT03M", "AAA", "DBAA", "VIX", "housng"))
results5 <- regr_results(a=regr5)

results5  %>%
  kbl(booktabs = T,longtable=T, align="c", digits=2, caption="Regression with state-dependency") %>%
   kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
       footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

```


\newpage
## Appendix I. 

```{r roll_regress, message = F, warnings = F,echo = F}
rownames(df_resultss)[rownames(df_resultss)=='Out-of-sample RMSFE'] <- "OOS RMSFE"
df_resultss %>%
  kbl(longtable=T, booktabs=T) %>%
  kable_styling() %>%
  footnote(general = "OOS refers to Out-of-sample")


df_results <- transpose(df_resultss)

df_resultss2 <- melt(df_resultss)
df_resultss2$rowid <- c("Out-of-sample RMSFE", "Recessionary", "Expansionary" ,"Naive", "TRM", "CRS")

ggplot(df_resultss2, aes(variable, value, group=factor(rowid))) + geom_line(aes(color=factor(rowid)))

```
\newpage


```{r randomforest, message=F, warnings=F,echo = F, include=F}
# train <- dataset[,2:22]
# test <- dataset[1:15,2:22]
# #The Random Forest
# train[,1:14] <- sapply(train[,1:14], as.numeric) #Convert all predictors to numeric variables
# set.seed(131) #Set randomizing seed for replication study
# 
# #The Random Forest Algorithm
# library(randomForest)
# gdp.rf <- randomForest(GDPC1 ~ .
# , data=train, importance=TRUE, na.action=na.omit)
# print(gdp.rf)
# #Variable importance measure
# imp <- importance(gdp.rf, type = 1)
# round(imp, 3)
# varImpPlot(gdp.rf)
# #Prediction
# test[1:15,1:114] <- sapply(test[1:15,1:114], as.numeric)
# pred.rf <- predict(gdp.rf, newdata=test, n.ahead=15)
# pred.rf
# #RMSE
# RMSE(test$GDPC1, pred.rf)
#  
```





