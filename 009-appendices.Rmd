---
title: "Appendices"
date: "12.11-2020"
output: 
  bookdown::pdf_document2:
    toc: no
csl: apa.csl
bibliography: library.bib
indent: yes
fontsize: 12pt
geometry: margin = 1in
link-citations: yes
linkcolor: blue
urlcolor: blue
header-includes:
- \usepackage{placeins}
- \usepackage{setspace}
- \usepackage{chngcntr}
- \usepackage{microtype}
- \counterwithin{figure}{section}
- \counterwithin{table}{section}
- \usepackage{float}
- \usepackage{amsmath}
- \DeclareMathOperator{\logit}{logit}
---

# Appendices
```{r run libraries, include=F}
library(stringr)
library(tidyverse)
library(summarytools)
library(kableExtra)
library(dynlm)
library(stats)
library(readr)
library(dplyr)
library(ggplot2)
library(data.table)
library(MacroRF)
require(data.table)
library(zoo)
library(sandwich)
library(randomForest)
library(caret)
library(fbi)
library(lmtest)
```




```{r fredqd}
start <- as.Date("01/03/1990", format="%d/%m/%Y")
end <- as.Date("01/09/2015", format="%d/%m/%Y")

yivgdp <- read_csv("data/gdp_yiv.csv")
yivgdp$Date <- as.Date(yivgdp$Date, format="%d.%m.%Y")
yivgdp <- yivgdp %>%
  mutate(log_gdp=log(1+GDP/100)*100)

fred_quarterly.raw <- read_csv("data/current.csv")
fred_quarterly.raw <- fred_quarterly.raw[-1:-2,]
fred_quarterly.raw$sasdate <- as.Date(fred_quarterly.raw$sasdate, format="%m/%d/%Y")
colnames(fred_quarterly.raw)[1] <- "Date"

fred_quarterly.raw[2:ncol(fred_quarterly.raw)] <- log(fred_quarterly.raw[2:ncol(fred_quarterly.raw)])
fred_quarterly.raw[2:ncol(fred_quarterly.raw)] <- fred_quarterly.raw[2:ncol(fred_quarterly.raw)] - lag(fred_quarterly.raw[2:ncol(fred_quarterly.raw)], 4)

dataset <- subset(fred_quarterly.raw, select = -c(92, 182, 184))
dataset<- subset(dataset, Date >= start)
dataset <- subset(dataset, Date <= end)

rownames(dataset) <- seq(length=nrow(dataset))
YIV <- yivgdp$YIV

dataset <- dataset %>%
  mutate(YIV)

# Import term rates
DGS.raw <- read_csv("data/feds/DGS_combined.csv")
DGS.clean<- subset(DGS.raw, DATE >= start)
DGS.clean <- subset(DGS.clean, DATE <= end)

DGS.clean$DGS3MO <- as.numeric(DGS.clean$DGS3MO)
DGS.clean$DGS6MO <- as.numeric(DGS.clean$DGS6MO)

DGS.clean <- DGS.clean %>%
  mutate(TRM0503 = DGS5-DGS3MO) %>%
  mutate(TRM0506 = DGS5-DGS6MO) %>%
  mutate(TRM1003 = DGS10-DGS3MO) %>%
  mutate(TRM1006 = DGS10-DGS6MO) %>%
  mutate(TRM1012 = DGS10-DGS1) %>%
  mutate(SRT03M = DGS3MO-lag(DGS3MO))

```




```{r child = 'Dataclean.rmd'}

```


```{r create_log, include=F}
df <- df %>%
  mutate(log_gdp=log(1+GDP/100)*100)

df <- df %>%
  arrange %>%
    mutate(H12=rollapply(log_gdp,5,FUN = function(df) mean(df[-5], na.rm = TRUE), fill = NA, align = "left" )) %>%
    mutate(H18=rollapply(log_gdp, 7,FUN = function(df) mean(df[-7], na.rm = TRUE), fill = NA, align = "left" )) %>%
    mutate(H24=rollapply(log_gdp, 9,FUN = function(df) mean(df[-9], na.rm = TRUE), fill = NA, align = "left" )) %>%
    mutate(H30=rollapply(log_gdp, 11,FUN = function(df) mean(df[-11], na.rm = TRUE), fill = NA, align = "left" )) %>%
    mutate(H36=rollapply(log_gdp, 13,FUN = function(df) mean(df[-13], na.rm = TRUE), fill = NA, align = "left" ))

```




```{r reg_output, include=F}

# define a function to get coefficients from linear regression
do_regression <- function(var)
  { # var - the name of the variable to be regressed
    res <- lm(as.formula(paste0(var, "~ YIV")), df) # run linear regression
    coefs <- c("Intercept" = summary(res)$coefficients[1,1],
               "Beta" = summary(res)$coefficients[-1,1],
               "Newey"=NeweyWest(res)[-1,1],
               "R-Squared"= summary(res)$r.squared*100,
               "Adj. R2"=summary(res)$adj.r.squared*100, 
               "p-value"= summary(res)$coefficients[-1,4],
               "RMSE" = sigma(res),
               "Std" = coeftest(res, vcov=vcovHC(res, type ="HC1"))[-1, "Std. Error"])
  return(coefs)
  }


df_results <- as.data.frame(t(sapply(colnames(df)[6:10], do_regression)))

df_results <- df_results %>%
  round(2)

df_results$'Significance'[df_results$'p-value' >= 0] <- "aaa"
df_results$'Significance'[df_results$'p-value' > 0.01] <- "aa"
df_results$'Significance'[df_results$'p-value' > 0.05] <- "a"
df_results$'Significance'[df_results$'p-value' > 0.1] <- "NA"



df_results$'Significance' <- gsub("a", "*", df_results$'Significance')
  
```

```{r reg_output_dummy, include=F}

# define a function to get coefficients from linear regression
do_regression2 <- function(var)
  { # var - the name of the variable to be regressed
    res <- lm(as.formula(paste0(var, "~ YIV +dum")), df) # run linear regression
    coefs <- c("Intercept" = summary(res)$coefficients[1,1], 
               "Beta" = summary(res)$coefficients[-1,1], 
               "Newey"=NeweyWest(res)[-1,1],
               "R-Squared"= summary(res)$r.squared*100,
               "Adj. R2"=summary(res)$adj.r.squared*100,  
               "p-value"= summary(res)$coefficients[-1,4],
               "RMSE" = sigma(res),
               "Std" = coeftest(res, vcov=vcovHC(res, type ="HC1"))[-1, "Std. Error"])
  return(coefs)
  }

df_results_dummy <- as.data.frame(t(sapply(colnames(df)[6:10], do_regression2)))

df_results_dummy <- df_results_dummy %>%
  round(2)

  
```





```{r bindtogether, include=F}
#This chunk needs to be minimized by first combining data alltogether into one big dataset & looping function.
statistics_GDP <- df %>%
  select(GDP, YIV) %>%
    descr(
      transpose=TRUE,
      stats = c("mean","sd","min","q1","med","q3","max","n.valid"))

statistics_feds <- feds %>%
  select (SVEN1F01) %>%
    descr(
      transpose=TRUE,
      stats = c("mean","sd","min","q1","med","q3","max","n.valid"))

statistics_dependent <- dependent %>%
  select (EMP, IND, CON) %>%
    descr(
      transpose=TRUE,
      stats = c("mean","sd","min","q1","med","q3","max","n.valid"))

statistics_vix <- vix_monthly %>%
  select(VIX) %>%
    descr(
      transpose=TRUE,
      stats = c("mean","sd","min","q1","med","q3","max","n.valid"))

statistics_housng <- housng %>%
  select(HOUSNG) %>%
    descr(
      transpose=TRUE,
      stats = c("mean","sd","min","q1","med","q3","max","n.valid"))


statistics <- t(cbind(t(statistics_GDP[nrow(statistics_GDP):1,]), t(statistics_dependent), t(statistics_feds) ,t(statistics_vix),t(statistics_housng)))

```
\newpage
## Appendix A

```{r reg_graphs, message = F, warnings = F, echo = F}

regression.coefficients <- ggplot(df_results, aes(x=row.names(df_results), y=Beta))+ geom_bar(stat="identity", fill="steelblue")+theme_minimal()+ xlab("Quarters") + ylab("Coefficients") + labs(title = "GDP coefficients") + theme(plot.title = element_text(hjust = 0.5))
                                                                                                                                                                          
regression.fit <- ggplot(df_results, aes(x=row.names(df_results),y=df_results$'R-Squared')) + geom_bar(stat="identity", fill="steelblue")+ theme_minimal() + xlab("Quarters") + ylab("R-squared") + labs(title = "GDP R-squared") +  theme(plot.title = element_text(hjust = 0.5))
regression.fit
regression.coefficients

```

\newpage
## Appendix B

```{r GDPvsYIV, message=F, warnings=F, echo = F, fig.cap="GDP Growth(%) vs 5-year Treasury Implied Volatility"}
par(mar = c(5, 5, 3, 5))
plot(df$Date, df$YIV, type = "l", xlab = "Date", ylab = "YIV (%)", col = "blue", main = "GDP growth vs YIV")
par(new=TRUE)
plot(df$Date, df$GDP, type = "l", xaxt = "n", yaxt = "n", xlab = "", ylab = "", col = "red", lty = 2)
axis(side = 4)
mtext("GDP growth(%)", side = 4, line = 3)
legend("topleft", c("YIV", "GDP"),
       col = c("blue", "red"), lty = c(1, 2))
```

\newpage
## Appendix C

Notes: This table includes summary statistics for main variables used in our research. Statistics include mean, standard deviation,, min, 1st quartile, median, 3rd quartile, max & number of valid data points. 
In Panel A, different YIV data is summarized. 
In Panel B, we have listed the main dependent variables which are used for predictions. GDP denotes the year-on-year growth rate(quarterly data), CON denotes YOY consumption growth(monthly data), EMP describes YOY growth rate for non-farm payroll and lastly IND stands for Industrial production YOY growth (monthly data).
In Panel C, different control variables are listed: SVEN1F01 - 1 year treasury bond par yield.


```{r summarystat, message = F, warnings = F, echo = F}

kbl(cbind(statistics), booktabs = T,  longtable=T, align="c", digits=2, caption="Summary Statistics") %>%
  kable_styling(latex_options = c("striped","repeat_header")) %>%
    pack_rows("Panel A: YIV",1,1, latex_align="c") %>%
      pack_rows("Panel B: Dependent Variables",2,5, latex_align="c") %>%
        pack_rows("Panel C: Control Variables",6,8, latex_align="c") %>%
          footnote(general = "Additional control variables will be added upon construction. Furthermore, currently the frequency of the datasets differs for different variables but this will be addressed in the research process.", threeparttable=T)

  

```
\newpage
## Appendix D. 

Notes: This table includes regression using GDP & YIV. Controls will be added during research process. The equation for the regression is the following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} + Controls +\varepsilon_{t+H}
\end{equation}

```{r tableOLS, message = F, warnings = F,echo = F}
kbl(cbind(t(df_results)), booktabs = T, longtable=T, align="c", digits=2, caption="Regression output") %>%
   kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
     pack_rows("Panel A: YIV",1,9, latex_align="c") %>%
       footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

```
\newpage
## Appendix E. 

Notes: This table includes regression using GDP & YIV. Controls will be added during research process. The equation for the regression is the following:

\begin{equation}
\sum_{j=1}^{j=H}log(1+GDP_{i,t+j})/H = \alpha_{H}+ \beta_{H} \sigma_{IV,t}^{INT} + Dummy +\varepsilon_{t+H}
\end{equation}

```{r mingiOLS, message = F, warnings = F,echo = F}
kbl(cbind(t(df_results_dummy)), booktabs = T,longtable=T, align="c", digits=2, caption="Regression with state-dependency") %>%
   kable_styling(latex_options = c("striped"), full_width = TRUE) %>%
     pack_rows("Panel A",1,1, latex_align="c") %>%
       footnote(general = "*** - p<0.01, ** - p<0.05, * - p<0.1. Reported standard error is adjusted for heteroskedasticity")

```
\newpage


## Appendix F

```{r randomforest, message=F, warnings=F,echo = F, include=F}
train <- fred_quarterly[,2:200]
test <- fred_quarterly[1:15,2:200]
#The Random Forest
train[,1:199] <- sapply(train[,1:199], as.numeric) #Convert all predictors to numeric variables
set.seed(131) #Set randomizing seed for replication study

#The Random Forest Algorithm
library(randomForest)
gdp.rf <- randomForest(GDPC1 ~ .
, data=train, importance=TRUE, na.action=na.omit)
print(gdp.rf)
#Variable importance measure
imp <- importance(gdp.rf, type = 1)
round(imp, 3)
varImpPlot(gdp.rf)
#Prediction
test[1:15,1:199] <- sapply(test[1:15,1:199], as.numeric)
pred.rf <- predict(gdp.rf, newdata=test, n.ahead=15)
pred.rf
#RMSE
RMSE(test$GDPC1, pred.rf)
 
```




